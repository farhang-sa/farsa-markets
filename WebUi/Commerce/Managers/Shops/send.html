<?php defined( 'Fallon_Root' ) or die( 'Access Denied : ' . basename( __FILE__ ) ) ;
if ( ! $App->COMMERCE()->isManager() ) return $Html->NotManagerAlert();
if ( $App->SilentCall( "commerce" , "managers" , "shops" , "new" ) ) { 
	return $Html->Alert( 'Shop Created Successfully' , 'success' );
} $Definition = $App->COMMERCE()->ReadShopDefinition();
$Definition[ 'template' ][0] = "selects" ;// Not select but select(s)
$Definition[ 'template' ][1] = $App->COMMERCE()->LoadShopTemplates();
$Definition[ 'template' ][2] = null ;
$Definition[ 'template' ][3] = null ;
$Definition[ 'template' ][4] = "multiple" ;
if( $Definition[ 'template' ][1][0] == "No Template" )
    unset( $Definition[ 'template' ][1][0] );
/*$Definition[ 'cloning_template' ][1] = $App->COMMERCE()->LoadShopCloningTemplates();
if( ! empty( $Definition[ 'cloning_template' ][1] ) ) 
	foreach ($Definition[ 'cloning_template' ][1] as $key => $value) 
		if( $key === $shop['code'] )
			unset( $Definition[ 'cloning_template' ][1][$key] );*/
if( isset( $Definition[ 'cloning_template' ] ) )
	unset( $Definition[ 'cloning_template' ] ); // Clean For Now !
$values = array( 'writer' => $App->User( "code" ) );
$values[ 'manager' ] = $App->User( "fullname" ) ;
$parent = isset( $parent ) ? $parent : $App->input->maid ;
if( $parent ) {
	$App->input->maid = $parent ;
	$parent = $App->COMMERCE()->PullManagerMalls( $App->User( 'code' ) );
	if( ! $parent ) $parent = array() ;
	array_unshift( $parent, 'COMMERCE' ) ;
	foreach ($parent as $k => $v) 
		if( $k === $App->input->maid )
			$parent[ $k ] = array( $parent[ $k ] ) ;
	$values['parent'] = $parent ;
} else unset( $Definition['parent' ] ) ;
$COMMERCESubjects = $App->COMMERCE()->LoadShopSubjects(); ?>
<div class="col-xs-12 <?php $Html->EchoDir() ; ?> <?php $Html->EchoAlign(); ?>"
	style="margin:20px 0px;">
	<h3 class="col-xs-12 alert alert-info" style="margin:10px 0px;">
		<?php $Html->pTranslate( 'Create An New Shop' ); ?>
	</h3>
	<form method="post">

		<?php if ( $parent === 'COMMERCE' || is_null( $parent ) ) : ?>
		<span class="col-xs-12 paddding10">
			<?php $Html->pTranslate( "Shop Subject" ) ; ?> :
		</span>
		<span class="col-xs-12 padding0" style="margin:5px 1px;display:block;">
			<?php foreach ( $COMMERCESubjects as $key => $value ) : ?>
			<span class="col-xs-6 col-sm-4 padding5" style="margin:0px;float:right;">
			<span class="btn btn-info align_right" 
			style="display:initial;margin:10px;padding:5px;">
				<input type='checkbox' name="new-shop[subjects][]"
					value='<?php print $key ; ?>' class="form-check-input" id="<?php print $key ; ?>" />
				<label class="form-check-label" for="<?php print $key ; ?>"
					style="display:initial;"><?php print $value ; ?></label>
			</span>
			</span>
			<?php endforeach ; ?>
		</span>
		<div class="col-xs-12 padding2"></div>
		<?php endif ; ?>

		<?php $Settings = $App->SilentCall( "System" ,
			"admins" , "Settings" , [ "settings_name" => "Commerce" ] );
		if( $Settings && isset( $Settings[ 'active_locations' ] ) ) :
			$aclo = $Settings[ 'active_locations' ] ;
			$aclo = $App->COMMERCE()->JSON_str_to_array( $aclo );
			$provs = array();
			foreach ($aclo as $key => $value) {
				$provs[ $key ] = $value[ "name" ] ;
				$aclo[ $key ] = $value[ "cities" ];
			}
		$first = array_keys( $aclo )[0] ; ?>
		<div class="col-xs-12 padding10"> </div>
		<div class="col-xs-12 text-center">
			<?php $Html->pTranslate( 'Select Province' ); ?>
		</div>
		<select name="new-shop[province]" 
			onchange='changeShopProvinceCities();'
				class="form-control input input-lg shop-province">
			<?php foreach ($provs as $key => $value) {
				print "<option value='{$key}'>{$value}</option>";
			}?>
		</select>
		<div class="col-xs-12 padding10"> </div>
		<div class="col-xs-12 text-center">
			<?php $Html->pTranslate( 'Select City' ); ?>
		</div>
		<select name="new-shop[city]"
			class="form-control input input-lg shop-city">
			<?php foreach ($aclo[$first] as $ce => $cf) {
				print "<option value='{$ce}'" ;
				if( isset( $values[ 'city' ] ) && $values[ 'city' ] === $ce)
					print " selected" ;
				print '>' . $cf['name'] . '</option>';
			}?>
		</select>
		<script type="text/javascript">
		var _active_location_cities = {
			
			<?php $out = "" ; 
			foreach ($aclo as $key => $value) {
				$out .= "\n'{$key}' : {";
				foreach ($value as $cn => $cv) 
					$out .= "\n\t'{$cn}' : '{$cv['name']}' ,";
				$out = trim( $out , " ," );
				$out .= "\n} , " ;
			} $out = trim( $out , " ," );
			print $out ; ?>
		};
		function changeShopProvinceCities(){
			$( 'select.shop-city option' ).each(function() {
			    $(this).remove();
			}); 
			var $selected = $('select.shop-province').find(":selected").val();
			var $cities = _active_location_cities[ $selected ];
			for (var $city in $cities) {
			    if ($cities.hasOwnProperty($city)) {
			    	var $op = $cities[$city] ;
			    	$op = '<option value="' + $city + '">' + $op + '</option>'
			    	$( 'select.shop-city' ).append( $op );
			    }
			}
		} </script>
		<?php endif ; ?>

		<?php $Html->ExecuteDefinition( 'new-shop' , $Definition , $values );?>

		<span class="col-xs-12 padding0" style="text-align:justify;">
			<b><?php $Html->pTranslate( 'Automatic Tags' ); ?> : </b><br />
			<?php print $App->getAutoTags(); ?>
		</span>

		<span class="col-xs-12 padding0" style="margin:5px 1px;">
			<input class="input input-lg form-control btn-success" 
			value="<?php print $App->Translate('Create This Shop') ;?>" 
			type="submit" name="save-shop">
		</span>

	</form>

</div>
<?php $randomId = 'rand_map_' . rand( 1000 , 9999 ); ?>
<div class="modal fade" id="limitation_coordinates_modal" tabindex="-1" 
    style='margin-top:65px;margin-bottom:50px;z-index:9999999;'
    role="dialog" aria-labelledby="NewAddressModal" aria-hidden="true">
  <div class="modal-dialog" role="document" style='height:100%;'>
    <div class="modal-content padding0" style='height:100%;'>
      <div class="modal-body padding0" style='display:block;height:85%;'>
        
        <?php $first = $aclo[ $first ];
        $first = array_values( $first )[0];
        $Html->Call( 'design' , 'tools' , 'maps_osm_openlayer' , 
            [ "mapId" => $randomId , 'zoom' => 13 , 'print_div' => 1 , 'select_coordinates' => true ,
                'centerLat' => $first['latitude'] , 'centerLog' => $first['longitude'] ] );?>
        
      </div>
      <div class="modal-footer" style='display:block;height:15%;padding:5px 15px;'>
        <button type="button" class="btn btn-lg btn-block btn-danger save-coordinates" data-dismiss="modal"><?php $Html->pTranslate( 'Save' ); ?></button>
      </div>
    </div>
  </div>
</div>
<script>
$( document ).ready(function(){
    $( '#limitation_coordinates_modal .save-coordinates' ).click(function(){
        var thisMap = window.fallon_map_<?php print $randomId ; ?>;
        if( ! thisMap.lastCoordinates ){
            Toast( "<?php $Html->pTranslate( 'Please Select Coordinates' ); ?>" );
            return ;
        } // else :
        $( '.delivery_limit_coordinates' ).val( thisMap.lastCoordinates );
    });
});
</script>