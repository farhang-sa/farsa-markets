<?php defined( 'Fallon_Root' ) or die( 'Access Denied : ' . basename( __FILE__ ) ) ; 
if ( ! $App->User()->isManager() ) 
	return $Html->NotManagerAlert(); ?>
<div class="col-xs-12 padding5">

	<div class="col-xs-12 padding5">

		<div class="col-xs-12 padding0">

			<h3 class="col-xs-12 alert-info" style="padding:15px;margin-top:15px;">

				<?php $Html->pTranslate( 'Edit Debt' ); ?>

			</h3>

		</div>

		<?php $shop = isset( $shop ) ? $shop : $App->input->shid ;
		if( is_array( $shop ) && isset( $shop[ 'code' ] ) )
			$shop = $shop[ 'code' ];	
		$bLink = "Commerce/Managers/my-shops/my-debtors" ;
		$lLink = $bLink . "/list/shid:" . $shop ;
		$eLink = $bLink . "/edit/shid:" . $shop ;
		$nLink = $bLink . "/send/shid:" . $shop ;
		$search = $App->input->search_keywords ; ?>

		<form method="POST" class="col-xs-12 padding5">

			<input name="search_keywords" value="<?php print $search ? $search : '';?>"
				class="input input-lg form-control text-center"
				placeholder="<?php $Html->pTranslate( 'Search Users' ); ?>" />

		</form>

		<?php $new = $App->SilentCall( 
			'Commerce' , 'Managers' , 'Debtors' , 'edit' );
		if( $new === true ) 
			$Html->Alert( 'Debt Edited Successfully' , 'success' );
		if( ! $shop ) :
			$Html->Alert( 'Please Select A Shop First' , 'info' );
		else : 
		$user = $App->SilentCall( "User" , 
			"Search" , [ 'UserId' => $search ] );

		if( isset( $user['User'] ) )
			unset( $user[ "User" ] ) ;
		if( $search && ! $user ) :
			$Html->Alert( 'No User for keyword : ' . $search , 'warning' );
		elseif( $user  ) : 
		$wh = "" ;
		$profile = array();
		$debts = array();
		if( ! isset( $user[ "code" ] ) ) : // Multiple Users !
			foreach ($user as $us )
				$wh .= "'" . $us['code'] . "' ," ;
			$wh = trim( $wh , " ," );
			$profile = $App->User()->LoadData( "users_profiles" , 
				[ "*" ] , [ "`writer` IN ( " . $wh . " )" ] );
			if( $profile && ! isset( $profile[ 'code' ] ) )
				foreach ($profile as $key => $value) {
					unset( $profile[$key] );
					$profile[ $value[ 'writer' ] ] = $value ;
				}
			elseif( $profile )
				$profile = array( $profile['code'] => $profile );
			$debts = $App->SilentCall( 'Commerce' , 'Managers' , 'Debtors' ,
				'list' , [ 'user' => $user ] ); ?>
			<div class="col-xs-12 padding5" style="margin-top:20px;">
			<?php if( isset( $user['code'] ) ) 
				$user = [ $user['code'] => $user ] ;
			foreach ($user as $us) :
				$wh = $us[ 'writer' ];
				print "<div class='col-xs-12 padding5'>";
				$wh = isset( $profile[ $wh ] ) ? $profile[ $wh ] : null ;
				if( ! $wh )
					$wh = array_merge( $us , [ 'name' => $us[ 'writer' ] ] ) ;
				$Html->Call( "user" , "profile" , "id" , [ "Profile" => $wh ] );
				if( isset( $debts[ $us[ 'writer' ] ] ) ) :
					// Edit Debts
					print "<div class='col-xs-12 padding5'>" ;
					$Html->pTranslate( 'Previous Debt' );
					print " : <br>" ;
					print Ted\HumanPrice( $debts[ $us[ 'writer' ] ]['amount'] ) . " " ;
					$Html->pTranslate( '$' );
					print " &#160; <a href='" ;
					$Html->EchoLink( $eLink . "/uid:" . $us['writer'] );
					print "' target='_blank'>" ;
					print "<span class='glyphicon glyphicon-edit'></span>";
					print "</a></div>" ;
				else : 
					print "<div class='col-xs-12 padding5'>" ;
					$Html->pTranslate( 'New Debt' );
					print " &#160; <a href='" ;
					$Html->EchoLink( $nLink . "/uid:" . $us['writer'] );
					print "' target='_blank'>" ;
					print "<span class='glyphicon glyphicon-plus'></span>";
					print "</a></div>" ;
				endif ;
				print "</div>";
			endforeach; ?>
			</div>
		<?php else : 
		$profile = $App->SilentCall( "User" , 
				"Profile" , [ "UserCode" => $user[ "writer" ] ] );
		$debts = $App->SilentCall( 'Commerce' , 'Managers' , 'Debtors' ,
			'list' , [ 'user' => $user ] );
		if( ! $debts ) :
			print "<div class='col-xs-12 padding5'>" ;
			$Html->pTranslate( 'New Debt' );
			print " &#160; <a href='" ;
			$Html->EchoLink( $nLink . "/uid:" . $us['writer'] );
			print "' target='_blank'>" ;
			print "<span class='glyphicon glyphicon-plus'></span>";
			print "</a></div>" ;
		else : // Edit Mode !
		$debts = array_pop( $debts ) ; ?>
		<div class="col-xs-12 padding5">
			<?php $Html->Call( "user" , "profile" , 
				"id" , [ "Profile" => $profile ] );
			$debts = $debts["amount" ] ;
			$debts = $debts + 0 <= 0 ? 0 : $debts ; ?>
			<h4 class="col-xs-12 padding5 alert-success"
				style="margin-top:10px;">

				<?php $Html->pTranslate('Debt Amount'); 
				print ' : ' . Ted\HumanPrice( $debts ) ;
				$Html->pTranslate( '$' ); ?>

			</h4>

			<form class="col-xs-12 item-view" 
				style="margin-top:15px;padding:10px;">

				<h4 class="col-xs-12 padding5" style="margin-top:10px;">
					<?php $Html->pTranslate( 'Set Debt Exact Amount' ); ?>
				</h4>
				<input type="number" min="0" step="500"
					name="debt_amount" 
					class="input input-lg form-control text-center"
					placeholder="<?php $Html->pTranslate( 'Debt Amount' ); ?>"
					value="<?php print $debts; ?>" />

				<input type="submit" class="btn btn-success"
					style="margin-top:10px;"
					value="<?php $Html->pTranslate( 'Set Amount' ); ?>" />

			</form>

			<form class="col-xs-12 item-view" 
				style="margin-top:15px;padding:10px;">

				<h4 class="col-xs-12 padding5" style="margin-top:10px;">
					<?php $Html->pTranslate( 'Increase By' ); ?>
				</h4>
				<span class="col-xs-4 text-center padding5 ltr">

					<h4 style="margin:0px;"><?php print $debts; ?> &#160; +</h4>

				</span>
				<span class="col-xs-8">
					<input type="number" min="0" step="500"
						name="debt_add_amount" 
						class="input input-lg form-control text-center"
						placeholder="<?php $Html->pTranslate('Increase Amount'); ?>"/>
					</span>
				<input type="submit" class="btn btn-success"
					style="margin-top:10px;"
					value="<?php $Html->pTranslate( 'Add Amount' ); ?>" />

			</form>

			<form class="col-xs-12 item-view" 
				style="margin-top:15px;padding:10px;">

				<h4 class="col-xs-12 padding5" style="margin-top:10px;">
					<?php $Html->pTranslate( 'Decrease By' ); ?>
				</h4>
				<span class="col-xs-4 text-center padding5 ltr">

					<h4 style="margin:0px;"><?php print $debts; ?> &#160; -</h4>

				</span>
				<span class="col-xs-8">
					<input type="number" min="0" step="500"
						name="debt_sub_amount" 
						class="input input-lg form-control text-center"
						placeholder="<?php $Html->pTranslate('Decrease Amount'); ?>"/>
					</span>
				<input type="submit" class="btn btn-success"
					style="margin-top:10px;"
					value="<?php $Html->pTranslate( 'Sub Amount' ); ?>" />

			</form>

		</div>
		<?php endif; endif ; endif ; endif ; ?>

	</div>

	<div class="col-xs-12 padding5" style="margin-top:15px;">

		<a href="<?php $Html->EchoLink( $lLink ); ?>" 
			class="btn btn-lg btn-primary">

			 &#160; <?php $Html->pTranslate( 'Go Back' ); ?> &#160; 

		</a>

	</div>

</div>